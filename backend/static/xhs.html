<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“• å°çº¢ä¹¦åˆ›ä½œåŠ©æ‰‹ - vibe-blog</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #E8F4F8 0%, #FFF8E7 50%, #FFE4CC 100%);
            min-height: 100vh;
            color: #4a4a4a;
        }
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 165, 0, 0.1);
        }
        .logo span {
            font-size: 24px; font-weight: 700;
            background: linear-gradient(135deg, #FFA500, #FFD700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-tabs { display: flex; gap: 10px; }
        .tab {
            padding: 10px 20px;
            background: rgba(255, 200, 124, 0.08);
            border: 1px solid rgba(255, 165, 0, 0.2);
            border-radius: 10px;
            color: #8B7355;
            font-size: 14px; cursor: pointer;
            text-decoration: none;
        }
        .tab:hover { background: rgba(255, 200, 124, 0.15); }
        .tab.active {
            background: linear-gradient(135deg, rgba(255, 200, 124, 0.25), rgba(255, 215, 0, 0.15));
            border-color: rgba(255, 165, 0, 0.6);
            color: #FFA500;
        }
        .hero { text-align: center; padding: 40px 20px 20px; }
        .hero h1 {
            font-size: 36px; font-weight: 700; margin-bottom: 12px;
            background: linear-gradient(135deg, #FFA500, #FFD700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hero p { font-size: 16px; color: rgba(0,0,0,0.6); }
        .main-card {
            max-width: 900px; margin: 30px auto; padding: 24px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 200, 124, 0.3);
            box-shadow: 0 8px 32px rgba(255, 165, 0, 0.08);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; margin-bottom: 8px;
            font-weight: 600; color: #333;
        }
        .text-input {
            width: 100%; padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
        }
        .text-input:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.1);
        }
        .options-row {
            display: flex; gap: 20px; flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .option-group { flex: 1; min-width: 150px; }
        .option-group label {
            display: block; margin-bottom: 6px;
            font-size: 14px; color: #666;
        }
        .option-group select {
            width: 100%; padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
        }
        .generate-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, #FFA500, #FFD700);
            border: none; border-radius: 12px;
            color: #fff; font-size: 16px; font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,107,53,0.3);
        }
        .generate-btn:disabled {
            opacity: 0.6; cursor: not-allowed;
            transform: none; box-shadow: none;
        }
        .result-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }
        .result-section.show { display: block; }
        .result-title {
            font-size: 20px; font-weight: 600;
            margin-bottom: 20px; color: #333;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .image-card {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            background: #fff;
        }
        .image-card img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
        }
        .image-card .caption {
            padding: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .copy-section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .copy-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        .copy-content {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .tag {
            background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,209,102,0.1));
            border: 1px solid rgba(255,107,53,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #FF6B35;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .loading.show { display: block; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #666; font-size: 14px; }
        .error-msg {
            background: #fff5f5;
            border: 1px solid #ffccc7;
            color: #cf1322;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }
        .error-msg.show { display: block; }
        
        /* ========== SSE è¿›åº¦æ¡æ ·å¼ ========== */
        .progress-container {
            display: none;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .progress-container.show { display: block; }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .cancel-btn {
            padding: 8px 16px;
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .cancel-btn:hover {
            background: #ff7875;
            transform: translateY(-1px);
        }
        
        .main-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .progress-bar {
            flex: 1;
            height: 12px;
            background: #e8e8e8;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFA500, #FFD700, #4ECDC4);
            background-size: 200% 100%;
            border-radius: 6px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            animation: gradientMove 2s ease infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .progress-glow {
            position: absolute;
            right: 0;
            top: 0;
            width: 30px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6));
            animation: glowPulse 1.5s ease-in-out infinite;
        }
        @keyframes glowPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .progress-percent {
            font-size: 16px;
            font-weight: 700;
            color: #FFA500;
            min-width: 50px;
            text-align: right;
        }
        
        .stage-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stage-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            background: #f5f5f5;
            border-radius: 12px;
            min-width: 70px;
            transition: all 0.3s ease;
            position: relative;
        }
        .stage-item.waiting { background: #f5f5f5; color: #999; }
        .stage-item.active {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.15));
            border: 2px solid #FFA500;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.2);
        }
        .stage-item.active .stage-icon { animation: bounce 1s ease infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .stage-item.completed {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.15), rgba(78, 205, 196, 0.25));
            border: 2px solid #4ECDC4;
        }
        .stage-item.completed::after {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #4ECDC4;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stage-icon { font-size: 20px; margin-bottom: 4px; }
        .stage-name { font-size: 11px; font-weight: 600; color: #333; }
        .stage-status { font-size: 9px; color: #999; margin-top: 2px; }
        .stage-item.active .stage-status { color: #FFA500; font-weight: 500; }
        .stage-item.completed .stage-status { color: #4ECDC4; }
        .stage-sub-progress { font-size: 9px; color: #FFA500; font-weight: 600; margin-top: 2px; }
        .stage-arrow { color: #ccc; font-size: 14px; font-weight: bold; }
        
        /* æ‚¬æµ®è¯¦æƒ…æ ·å¼ */
        .stage-item { position: relative; cursor: pointer; }
        .stage-detail {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 11px;
            white-space: pre-line;
            min-width: 180px;
            max-width: 280px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .stage-detail::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }
        .stage-item:hover .stage-detail { display: block !important; }
        .stage-item.waiting:hover .stage-detail { display: none !important; }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .current-stage { font-size: 14px; color: #666; }
        .time-estimate { font-size: 13px; color: #999; }
        
        /* å›¾ç‰‡å ä½ç¬¦ */
        .image-card.loading {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 3/4;
        }
        .image-card.loading .placeholder {
            text-align: center;
            color: #999;
        }
        .image-card.loading .mini-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e0e0e0;
            border-top-color: #FFA500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }
        .image-card img {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><span>vibe-blog</span></div>
        <div class="nav-tabs">
            <a href="/" class="tab">ğŸ“ é•¿æ–‡åšå®¢</a>
            <div class="tab active">ğŸ“• å°çº¢ä¹¦åˆ›ä½œ</div>
        </div>
    </nav>

    <section class="hero">
        <h1>ğŸ“• å°çº¢ä¹¦åˆ›ä½œåŠ©æ‰‹</h1>
        <p>è¾“å…¥ä¸»é¢˜ï¼Œä¸€é”®ç”Ÿæˆå°çº¢ä¹¦é£æ ¼ä¿¡æ¯å›¾ç³»åˆ—</p>
    </section>

    <div class="main-card">
        <div class="form-group">
            <label>ğŸ“Œ è¾“å…¥ä¸»é¢˜</label>
            <textarea class="text-input" id="topicInput" placeholder="ä¾‹å¦‚ï¼šRAGæŠ€æœ¯å…¥é—¨ã€Redisç¼“å­˜åŸç†ã€Pythonè£…é¥°å™¨è¯¦è§£..."></textarea>
        </div>

        <div class="options-row">
            <div class="option-group">
                <label>ğŸ“„ é¡µé¢æ•°é‡</label>
                <select id="countSelect">
                    <option value="3">3 é¡µ</option>
                    <option value="4" selected>4 é¡µ</option>
                    <option value="5">5 é¡µ</option>
                    <option value="6">6 é¡µ</option>
                </select>
            </div>
            <div class="option-group">
                <label>ğŸ¨ è§†è§‰é£æ ¼</label>
                <select id="styleSelect">
                    <option value="hand_drawn">æ¸©æš–æ‰‹ç»˜é£</option>
                    <option value="claymation">é»åœŸåŠ¨ç”»é£</option>
                    <option value="ghibli_summer">ğŸŒ» å®«å´éªçš„å¤å¤©ï¼ˆæ¼«ç”»åˆ†é•œï¼‰</option>
                </select>
            </div>
            <div class="option-group">
                <label>ğŸ¬ åŠ¨ç”»å°é¢</label>
                <select id="videoSelect">
                    <option value="false">ä»…é™æ€å›¾</option>
                    <option value="true">ç”ŸæˆåŠ¨ç”»</option>
                </select>
            </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateXHS()">
            âœ¨ å¼€å§‹ç”Ÿæˆ
        </button>

        <div class="error-msg" id="errorMsg"></div>

        <!-- SSE è¿›åº¦æ¡ç»„ä»¶ -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-header">
                <span class="progress-title" id="progressTitle">ğŸš€ å°çº¢ä¹¦å†…å®¹ç”Ÿæˆä¸­...</span>
                <button class="cancel-btn" id="cancelBtn" onclick="cancelGeneration()">å–æ¶ˆç”Ÿæˆ</button>
            </div>
            
            <div class="main-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-glow"></div>
                    </div>
                </div>
                <span class="progress-percent" id="progressPercent">0%</span>
            </div>
            
            <div class="stage-indicators">
                <div class="stage-item waiting" data-stage="search" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ”</div>
                    <div class="stage-name">æœç´¢</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
                <div class="stage-arrow">â†’</div>
                <div class="stage-item waiting" data-stage="outline" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ“‹</div>
                    <div class="stage-name">å¤§çº²</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
                <div class="stage-arrow">â†’</div>
                <div class="stage-item waiting" data-stage="content" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ“</div>
                    <div class="stage-name">æ–‡æ¡ˆ</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
                <div class="stage-arrow">â†’</div>
                <div class="stage-item waiting" data-stage="storyboard" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ¨</div>
                    <div class="stage-name">åˆ†é•œ</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
                <div class="stage-arrow">â†’</div>
                <div class="stage-item waiting" data-stage="images" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ–¼ï¸</div>
                    <div class="stage-name">å›¾ç‰‡</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-sub-progress" style="display:none;">(0/4)</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
                <div class="stage-arrow">â†’</div>
                <div class="stage-item waiting" data-stage="video" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    <div class="stage-icon">ğŸ¬</div>
                    <div class="stage-name">è§†é¢‘</div>
                    <div class="stage-status">ç­‰å¾…ä¸­</div>
                    <div class="stage-detail" style="display:none;"></div>
                </div>
            </div>
            
            <div class="progress-info">
                <span class="current-stage" id="currentStage">å‡†å¤‡ä¸­...</span>
                <span class="time-estimate" id="timeEstimate">é¢„è®¡å‰©ä½™: --</span>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <h2 class="result-title">ğŸ‰ ç”Ÿæˆå®Œæˆ</h2>
            
            <h3 style="margin-bottom: 12px;">ğŸ“· ä¿¡æ¯å›¾é¢„è§ˆ</h3>
            <div class="images-grid" id="imagesGrid"></div>

            <div class="copy-section">
                <h3>ğŸ“ æ¨èæ ‡é¢˜</h3>
                <div id="titlesList" style="margin-bottom: 16px;"></div>
                
                <h3>ğŸ“„ æ–‡æ¡ˆå†…å®¹</h3>
                <div class="copy-content" id="copyContent"></div>
                
                <h3 style="margin-top: 16px;">ğŸ·ï¸ æ¨èæ ‡ç­¾</h3>
                <div class="tags-list" id="tagsList"></div>
            </div>
            
            <!-- å‘å¸ƒæŒ‰é’®åŒºåŸŸ -->
            <div class="publish-section" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <h3 style="margin-bottom: 12px;">ğŸš€ å‘å¸ƒåˆ°å°çº¢ä¹¦</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
                    è¯·å…ˆåœ¨æµè§ˆå™¨ç™»å½•å°çº¢ä¹¦åˆ›ä½œè€…ä¸­å¿ƒï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨æ‰©å±•å¯¼å‡º Cookie
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="publish-btn" onclick="copyToClipboard()" style="
                        padding: 12px 24px;
                        background: #fff;
                        border: 1px solid #FF6B35;
                        border-radius: 8px;
                        color: #FF6B35;
                        font-size: 14px;
                        cursor: pointer;
                    ">
                        ğŸ“‹ å¤åˆ¶æ–‡æ¡ˆ
                    </button>
                    <button class="publish-btn" onclick="downloadImages()" style="
                        padding: 12px 24px;
                        background: #fff;
                        border: 1px solid #FF6B35;
                        border-radius: 8px;
                        color: #FF6B35;
                        font-size: 14px;
                        cursor: pointer;
                    ">
                        ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                    </button>
                    <button class="publish-btn" onclick="openPublishDialog()" style="
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #FF6B35, #FFD166);
                        border: none;
                        border-radius: 8px;
                        color: #fff;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                        ğŸš€ ä¸€é”®å‘å¸ƒ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å‘å¸ƒå¼¹çª— -->
    <div id="publishModal" style="
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    ">
        <div style="
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <h3 style="margin-bottom: 16px;">ğŸ” è¾“å…¥å°çº¢ä¹¦ Cookie</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
                åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ ä»»æ„è¯·æ±‚ â†’ Headers â†’ Cookieï¼Œå¤åˆ¶ç²˜è´´å³å¯ï¼š
            </p>
            <textarea id="cookieInput" placeholder='ç›´æ¥ç²˜è´´ Cookie å­—ç¬¦ä¸²ï¼Œå¦‚: a1=xxx; webId=yyy; web_session=zzz' style="
                width: 100%;
                height: 150px;
                padding: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                font-family: monospace;
                font-size: 12px;
                resize: vertical;
            "></textarea>
            <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;">
                <button onclick="closePublishDialog()" style="
                    padding: 10px 20px;
                    background: #f5f5f5;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">å–æ¶ˆ</button>
                <button onclick="publishToXHS()" style="
                    padding: 10px 20px;
                    background: linear-gradient(135deg, #FF6B35, #FFD166);
                    border: none;
                    border-radius: 8px;
                    color: #fff;
                    font-weight: 600;
                    cursor: pointer;
                ">ç¡®è®¤å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- åˆ†é•œè¯¦æƒ…é¢æ¿ -->
    <div id="storyboardPanel" style="
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        width: 450px;
        height: 100vh;
        background: #fff;
        box-shadow: -4px 0 20px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow-y: auto;
    ">
        <div style="
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #FF6B35, #FFD166);
            color: #fff;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3 style="margin: 0; font-size: 16px;">ğŸ¨ åˆ†é•œè§†è§‰æŒ‡ä»¤</h3>
            <button onclick="closeStoryboardPanel()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: #fff;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
            ">Ã—</button>
        </div>
        <div id="storyboardContent" style="padding: 16px;"></div>
    </div>

    <!-- å¤§çº²è¯¦æƒ…é¢æ¿ -->
    <div id="outlinePanel" style="
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        width: 450px;
        height: 100vh;
        background: #fff;
        box-shadow: -4px 0 20px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow-y: auto;
    ">
        <div style="
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: #fff;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3 style="margin: 0; font-size: 16px;">ğŸ“‹ å®Œæ•´å¤§çº²</h3>
            <button onclick="closeOutlinePanel()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: #fff;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
            ">Ã—</button>
        </div>
        <div id="outlineContent" style="padding: 16px;"></div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let currentResult = null;
        let currentTaskId = null;
        let eventSource = null;
        let startTime = null;
        let pageCount = 4;
        // æ–°æµç¨‹ï¼šæœç´¢ â†’ å¤§çº² â†’ æ–‡æ¡ˆ â†’ åˆ†é•œ â†’ å›¾ç‰‡ â†’ è§†é¢‘
        const stages = ['search', 'outline', 'content', 'storyboard', 'images', 'video'];
        // å­˜å‚¨å„é˜¶æ®µè¯¦æƒ…æ•°æ®
        const stageDetails = {};
        
        // ========== SSE ç”Ÿæˆå‡½æ•° ==========
        async function generateXHS() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                showError('è¯·è¾“å…¥ä¸»é¢˜');
                return;
            }

            pageCount = parseInt(document.getElementById('countSelect').value);
            const style = document.getElementById('styleSelect').value;
            const generateVideo = document.getElementById('videoSelect').value === 'true';

            // é‡ç½® UI çŠ¶æ€
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('errorMsg').classList.remove('show');
            resetProgress();
            showProgress();
            initImagePlaceholders(pageCount);

            try {
                // 1. åˆ›å»ºä»»åŠ¡
                const response = await fetch('/api/xhs/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        count: pageCount,
                        style,
                        generate_video: generateVideo
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
                }

                currentTaskId = result.task_id;
                startTime = Date.now();
                
                // 2. å»ºç«‹ SSE è¿æ¥
                connectSSE(currentTaskId);

            } catch (error) {
                showError(error.message);
                hideProgress();
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        // ========== SSE è¿æ¥ ==========
        function connectSSE(taskId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/xhs/stream/${taskId}`);
            
            // è¿›åº¦äº‹ä»¶
            eventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                updateProgress(data);
            });
            
            // æœç´¢å®Œæˆäº‹ä»¶
            eventSource.addEventListener('search', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ” æœç´¢å®Œæˆ:', data.results_count, 'æ¡ç»“æœ');
                stageDetails.search = data;
                updateStageDetail('search', `${data.results_count} æ¡ç»“æœ\næ¥æº: ${data.sources?.join(', ') || 'é€šç”¨'}`);
            });
            
            // å¤§çº²äº‹ä»¶
            eventSource.addEventListener('outline', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ“‹ å¤§çº²ç”Ÿæˆå®Œæˆ:', data.pages?.length, 'é¡µ');
                stageDetails.outline = data;
                updateStageDetail('outline', `${data.summary || ''}\nç‚¹å‡»æŸ¥çœ‹å®Œæ•´å¤§çº²`);
                // æ˜¾ç¤ºå¤§çº²è¯¦æƒ…é¢æ¿
                showOutlinePanel(data);
            });
            
            // æ–‡æ¡ˆäº‹ä»¶
            eventSource.addEventListener('content', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ“ æ–‡æ¡ˆç”Ÿæˆå®Œæˆ');
                stageDetails.content = data;
                renderContent(data);
                updateStageDetail('content', `æ ‡é¢˜: ${data.titles?.[0] || ''}\næ ‡ç­¾: ${data.tags?.slice(0, 3).join(', ') || ''}`);
            });
            
            // åˆ†é•œäº‹ä»¶
            eventSource.addEventListener('storyboard', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ¨ åˆ†é•œè®¾è®¡å®Œæˆ:', data.total, 'ä¸ªç”»é¢');
                stageDetails.storyboard = data;
                updateStageDetail('storyboard', `å…± ${data.total} ä¸ªåˆ†é•œ\næ‚¬æµ®å›¾ç‰‡æŸ¥çœ‹è§†è§‰æŒ‡ä»¤`);
                // ä¸å†è‡ªåŠ¨å¼¹å‡ºä¾§è¾¹é¢æ¿ï¼Œæ”¹ä¸ºåœ¨å›¾ç‰‡ä¸Šæ‚¬æµ®æ˜¾ç¤º
            });
            
            // å›¾ç‰‡è¿›åº¦äº‹ä»¶
            eventSource.addEventListener('image_progress', (e) => {
                const data = JSON.parse(e.data);
                console.log(`ğŸ–¼ï¸ å›¾ç‰‡ ${data.index} çŠ¶æ€: ${data.status}`);
                updateImageSlotStatus(data.index, data.status, data.progress);
            });
            
            // å›¾ç‰‡å®Œæˆäº‹ä»¶
            eventSource.addEventListener('image', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆå®Œæˆ:', data.index);
                renderSingleImage(data.index, data.url, data.page_type);
            });
            
            // è§†é¢‘äº‹ä»¶
            eventSource.addEventListener('video', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ¬ è§†é¢‘ç”Ÿæˆå®Œæˆ:', data.url);
                stageDetails.video = data;
                updateStageDetail('video', 'åŠ¨ç”»å°é¢å·²ç”Ÿæˆ');
            });
            
            // å®Œæˆäº‹ä»¶
            eventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                console.log('ğŸ‰ ç”Ÿæˆå®Œæˆ');
                eventSource.close();
                eventSource = null;
                onGenerationComplete(data);
            });
            
            // é”™è¯¯äº‹ä»¶
            eventSource.addEventListener('error', (e) => {
                if (e.data) {
                    const data = JSON.parse(e.data);
                    console.error('âŒ ç”Ÿæˆé”™è¯¯:', data.message);
                    eventSource.close();
                    eventSource = null;
                    onGenerationError(data.message);
                }
            });
            
            // å–æ¶ˆäº‹ä»¶
            eventSource.addEventListener('cancelled', (e) => {
                const data = JSON.parse(e.data);
                console.log('âš ï¸ ä»»åŠ¡å·²å–æ¶ˆ');
                eventSource.close();
                eventSource = null;
                onGenerationCancelled();
            });
            
            // è¿æ¥é”™è¯¯
            eventSource.onerror = (e) => {
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('SSE è¿æ¥å·²å…³é—­');
                }
            };
        }
        
        // ========== é˜¶æ®µè¯¦æƒ…æ›´æ–° ==========
        function updateStageDetail(stage, detail) {
            const item = document.querySelector(`[data-stage="${stage}"]`);
            if (item) {
                const detailEl = item.querySelector('.stage-detail');
                if (detailEl) {
                    detailEl.textContent = detail;
                }
            }
        }
        
        // ========== åˆ†é•œé¢æ¿ ==========
        function showStoryboardPanel(prompts) {
            const panel = document.getElementById('storyboardPanel');
            const content = document.getElementById('storyboardContent');
            
            let html = '';
            prompts.forEach((p, i) => {
                html += `
                    <div style="
                        background: #f9f9f9;
                        border-radius: 12px;
                        padding: 16px;
                        margin-bottom: 16px;
                        border-left: 4px solid ${p.page_type === 'cover' ? '#FF6B35' : p.page_type === 'summary' ? '#4ECDC4' : '#FFD166'};
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        ">
                            <span style="
                                font-weight: 600;
                                color: #333;
                            ">ç¬¬ ${p.index + 1} é¡µ (${p.page_type})</span>
                            <button onclick="copyPrompt(${i})" style="
                                background: #fff;
                                border: 1px solid #ddd;
                                padding: 4px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 12px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre id="prompt-${i}" style="
                            background: #fff;
                            padding: 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                            word-break: break-word;
                            margin: 0;
                            max-height: 300px;
                            overflow-y: auto;
                            border: 1px solid #eee;
                        ">${escapeHtml(p.prompt || '')}</pre>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            panel.style.display = 'block';
        }
        
        function closeStoryboardPanel() {
            document.getElementById('storyboardPanel').style.display = 'none';
        }
        
        function copyPrompt(index) {
            const pre = document.getElementById(`prompt-${index}`);
            if (pre) {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== å¤§çº²é¢æ¿ ==========
        function showOutlinePanel(data) {
            const panel = document.getElementById('outlinePanel');
            const content = document.getElementById('outlineContent');
            
            let html = '';
            
            // æ˜¾ç¤ºå®Œæ•´å¤§çº²æ–‡æœ¬
            if (data.outline) {
                html += `
                    <div style="
                        background: #f0f9f7;
                        border-radius: 12px;
                        padding: 16px;
                        margin-bottom: 16px;
                        border-left: 4px solid #4ECDC4;
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        ">
                            <span style="font-weight: 600; color: #333;">ğŸ“ å®Œæ•´å¤§çº²</span>
                            <button onclick="copyOutline()" style="
                                background: #fff;
                                border: 1px solid #ddd;
                                padding: 4px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 12px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre id="outline-text" style="
                            background: #fff;
                            padding: 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                            word-break: break-word;
                            margin: 0;
                            max-height: 300px;
                            overflow-y: auto;
                            border: 1px solid #eee;
                        ">${escapeHtml(data.outline)}</pre>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæ¯é¡µå†…å®¹
            if (data.pages && data.pages.length > 0) {
                html += `<h4 style="margin: 16px 0 12px; color: #333;">ğŸ“„ å„é¡µå†…å®¹</h4>`;
                data.pages.forEach((p, i) => {
                    const typeColor = p.page_type === 'cover' ? '#FF6B35' : p.page_type === 'summary' ? '#4ECDC4' : '#FFD166';
                    html += `
                        <div style="
                            background: #f9f9f9;
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 12px;
                            border-left: 4px solid ${typeColor};
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 8px;
                            ">
                                <span style="font-weight: 600; color: #333;">
                                    ç¬¬ ${p.index + 1} é¡µ 
                                    <span style="
                                        background: ${typeColor};
                                        color: #fff;
                                        padding: 2px 8px;
                                        border-radius: 4px;
                                        font-size: 11px;
                                        margin-left: 8px;
                                    ">${p.page_type}</span>
                                </span>
                            </div>
                            <div style="
                                background: #fff;
                                padding: 12px;
                                border-radius: 8px;
                                font-size: 13px;
                                line-height: 1.6;
                                border: 1px solid #eee;
                            ">${escapeHtml(p.content || 'æš‚æ— å†…å®¹')}</div>
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
            panel.style.display = 'block';
        }
        
        function closeOutlinePanel() {
            document.getElementById('outlinePanel').style.display = 'none';
        }
        
        function copyOutline() {
            const pre = document.getElementById('outline-text');
            if (pre) {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }
        }
        
        // ========== å›¾ç‰‡æ§½ä½çŠ¶æ€æ›´æ–° ==========
        function updateImageSlotStatus(index, status, progress) {
            const slot = document.getElementById(`image-slot-${index}`);
            if (slot && slot.classList.contains('loading')) {
                const placeholder = slot.querySelector('.placeholder span');
                if (placeholder) {
                    if (status === 'generating') {
                        placeholder.textContent = `ç¬¬ ${index + 1} é¡µ ç”Ÿæˆä¸­...`;
                    } else if (status === 'failed') {
                        placeholder.textContent = `ç¬¬ ${index + 1} é¡µ å¤±è´¥`;
                        slot.style.opacity = '0.5';
                    }
                }
            }
        }
        
        // ========== å–æ¶ˆç”Ÿæˆ ==========
        async function cancelGeneration() {
            if (!currentTaskId) return;
            
            try {
                await fetch(`/api/xhs/tasks/${currentTaskId}/cancel`, { method: 'POST' });
            } catch (e) {
                console.error('å–æ¶ˆè¯·æ±‚å¤±è´¥:', e);
            }
            
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            onGenerationCancelled();
        }
        
        // ========== è¿›åº¦æ¡æ§åˆ¶ ==========
        function showProgress() {
            document.getElementById('progressContainer').classList.add('show');
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('show');
        }
        
        function resetProgress() {
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentStage').textContent = 'å‡†å¤‡ä¸­...';
            document.getElementById('timeEstimate').textContent = 'é¢„è®¡å‰©ä½™: --';
            document.getElementById('progressTitle').textContent = 'ğŸš€ å°çº¢ä¹¦å†…å®¹ç”Ÿæˆä¸­...';
            document.getElementById('cancelBtn').style.display = 'block';
            
            // æ¸…ç©ºè¯¦æƒ…æ•°æ®
            Object.keys(stageDetails).forEach(k => delete stageDetails[k]);
            
            // é‡ç½®æ‰€æœ‰é˜¶æ®µçŠ¶æ€
            stages.forEach(stage => {
                const item = document.querySelector(`[data-stage="${stage}"]`);
                if (item) {
                    item.classList.remove('waiting', 'active', 'completed');
                    item.classList.add('waiting');
                    item.querySelector('.stage-status').textContent = 'ç­‰å¾…ä¸­';
                    const subProgress = item.querySelector('.stage-sub-progress');
                    if (subProgress) subProgress.style.display = 'none';
                    const detailEl = item.querySelector('.stage-detail');
                    if (detailEl) detailEl.textContent = '';
                }
            });
        }
        
        function updateProgress(data) {
            const { stage, progress, message, sub_progress } = data;
            
            // æ›´æ–°ä¸»è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${progress}%`;
            document.getElementById('currentStage').textContent = message;
            
            // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
            updateStageIndicators(stage, sub_progress);
            
            // æ›´æ–°é¢„ä¼°æ—¶é—´
            updateTimeEstimate(progress);
        }
        
        function updateStageIndicators(currentStage, subProgress) {
            let stageIndex = stages.indexOf(currentStage);
            
            // å¦‚æœæ˜¯ complete é˜¶æ®µï¼Œæ‰€æœ‰é˜¶æ®µéƒ½æ ‡è®°ä¸ºå®Œæˆ
            const isComplete = currentStage === 'complete';
            if (isComplete) {
                stageIndex = stages.length;
            }
            
            stages.forEach((stage, index) => {
                const item = document.querySelector(`[data-stage="${stage}"]`);
                if (!item) return;
                
                const statusEl = item.querySelector('.stage-status');
                const subEl = item.querySelector('.stage-sub-progress');
                
                item.classList.remove('waiting', 'active', 'completed');
                
                if (index < stageIndex || isComplete) {
                    item.classList.add('completed');
                    statusEl.textContent = 'å·²å®Œæˆ';
                    if (subEl) subEl.style.display = 'none';
                } else if (index === stageIndex) {
                    item.classList.add('active');
                    statusEl.textContent = 'è¿›è¡Œä¸­';
                    
                    if (subProgress && subEl) {
                        subEl.textContent = `(${subProgress.current}/${subProgress.total})`;
                        subEl.style.display = 'block';
                    }
                } else {
                    item.classList.add('waiting');
                    statusEl.textContent = 'ç­‰å¾…ä¸­';
                }
            });
        }
        
        function updateTimeEstimate(progress) {
            if (!startTime || progress <= 0) return;
            
            const elapsed = (Date.now() - startTime) / 1000;
            const estimated = (elapsed / progress) * (100 - progress);
            
            const timeEl = document.getElementById('timeEstimate');
            if (estimated > 60) {
                timeEl.textContent = `é¢„è®¡å‰©ä½™: ${Math.ceil(estimated / 60)} åˆ†é’Ÿ`;
            } else {
                timeEl.textContent = `é¢„è®¡å‰©ä½™: ${Math.ceil(estimated)} ç§’`;
            }
        }
        
        // ========== å›¾ç‰‡å®æ—¶æ¸²æŸ“ ==========
        function initImagePlaceholders(count) {
            const imagesGrid = document.getElementById('imagesGrid');
            imagesGrid.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const card = document.createElement('div');
                card.className = 'image-card loading';
                card.id = `image-slot-${i}`;
                card.innerHTML = `
                    <div class="placeholder">
                        <div class="mini-spinner"></div>
                        <span>ç¬¬ ${i + 1} é¡µ</span>
                    </div>
                `;
                imagesGrid.appendChild(card);
            }
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼ˆå›¾ç‰‡å ä½ç¬¦ï¼‰
            document.getElementById('resultSection').classList.add('show');
        }
        
        function renderSingleImage(index, url, pageType) {
            const slot = document.getElementById(`image-slot-${index}`);
            if (slot) {
                slot.className = 'image-card';
                
                // è·å–å¯¹åº”çš„åˆ†é•œè§†è§‰æŒ‡ä»¤
                const promptData = stageDetails.storyboard?.prompts?.[index];
                const hasPrompt = promptData && promptData.prompt;
                
                slot.innerHTML = `
                    <img src="${url}" alt="ç¬¬${index + 1}å¼ " onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22267%22><rect fill=%22%23f0f0f0%22 width=%22200%22 height=%22267%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22>åŠ è½½å¤±è´¥</text></svg>'">
                    <div class="caption">ç¬¬ ${index + 1} é¡µ${index === 0 ? ' (å°é¢)' : ''}</div>
                    ${hasPrompt ? `
                    <div class="prompt-tooltip" style="
                        display: none;
                        position: absolute;
                        top: 0;
                        left: 105%;
                        width: 350px;
                        max-height: 400px;
                        background: #fff;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                        z-index: 100;
                        overflow: hidden;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #FF6B35, #FFD166);
                            color: #fff;
                            padding: 10px 14px;
                            font-weight: 600;
                            font-size: 13px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <span>ğŸ¨ ç¬¬ ${index + 1} é¡µè§†è§‰æŒ‡ä»¤</span>
                            <button onclick="event.stopPropagation(); copyImagePrompt(${index})" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                padding: 4px 10px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre id="img-prompt-${index}" style="
                            padding: 12px 14px;
                            font-size: 11px;
                            line-height: 1.5;
                            white-space: pre-wrap;
                            word-break: break-word;
                            margin: 0;
                            max-height: 320px;
                            overflow-y: auto;
                            background: #fafafa;
                        ">${escapeHtml(promptData.prompt)}</pre>
                    </div>
                    ` : ''}
                `;
                
                // æ·»åŠ æ‚¬æµ®äº‹ä»¶
                if (hasPrompt) {
                    slot.style.position = 'relative';
                    slot.onmouseenter = () => {
                        const tooltip = slot.querySelector('.prompt-tooltip');
                        if (tooltip) tooltip.style.display = 'block';
                    };
                    slot.onmouseleave = () => {
                        const tooltip = slot.querySelector('.prompt-tooltip');
                        if (tooltip) tooltip.style.display = 'none';
                    };
                }
            }
        }
        
        function copyImagePrompt(index) {
            const pre = document.getElementById(`img-prompt-${index}`);
            if (pre) {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }
        }
        
        // ========== æ–‡æ¡ˆå®æ—¶æ¸²æŸ“ ==========
        function renderContent(data) {
            // æ˜¾ç¤ºæ ‡é¢˜
            const titlesList = document.getElementById('titlesList');
            if (data.titles && data.titles.length > 0) {
                titlesList.innerHTML = data.titles.map((title, i) => 
                    `<div style="padding: 8px 12px; background: ${i === 0 ? '#fff3e0' : '#f5f5f5'}; border-radius: 8px; margin-bottom: 8px; ${i === 0 ? 'border: 1px solid #FF6B35;' : ''}">
                        ${i === 0 ? 'â­ ' : ''}${title}
                    </div>`
                ).join('');
            }

            // æ˜¾ç¤ºæ–‡æ¡ˆ
            document.getElementById('copyContent').textContent = data.copywriting || '';

            // æ˜¾ç¤ºæ ‡ç­¾
            const tagsList = document.getElementById('tagsList');
            if (data.tags && data.tags.length > 0) {
                tagsList.innerHTML = data.tags.map(tag => 
                    `<span class="tag">#${tag}</span>`
                ).join('');
            }
        }
        
        // ========== å®Œæˆ/é”™è¯¯/å–æ¶ˆå¤„ç† ==========
        function onGenerationComplete(data) {
            currentResult = data;
            
            // æ›´æ–°è¿›åº¦æ¡ä¸ºå®ŒæˆçŠ¶æ€
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressPercent').textContent = '100%';
            document.getElementById('progressTitle').textContent = 'ğŸ‰ ç”Ÿæˆå®Œæˆï¼';
            document.getElementById('currentStage').textContent = 'å…¨éƒ¨å®Œæˆ';
            
            const elapsed = Math.ceil((Date.now() - startTime) / 1000);
            document.getElementById('timeEstimate').textContent = `æ€»è€—æ—¶: ${elapsed} ç§’`;
            
            // æ ‡è®°æ‰€æœ‰é˜¶æ®µä¸ºå®Œæˆ
            stages.forEach(stage => {
                const item = document.querySelector(`[data-stage="${stage}"]`);
                if (item) {
                    item.classList.remove('waiting', 'active');
                    item.classList.add('completed');
                    item.querySelector('.stage-status').textContent = 'å·²å®Œæˆ';
                }
            });
            
            // éšè—å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelBtn').style.display = 'none';
            
            // ç¡®ä¿æ‰€æœ‰å›¾ç‰‡éƒ½æ¸²æŸ“äº†
            if (data.image_urls) {
                data.image_urls.forEach((url, index) => {
                    const slot = document.getElementById(`image-slot-${index}`);
                    if (slot && slot.classList.contains('loading')) {
                        renderSingleImage(index, url, data.pages?.[index]?.page_type || 'content');
                    }
                });
            }
            
            // ç¡®ä¿æ–‡æ¡ˆæ¸²æŸ“äº†
            if (data.titles || data.copywriting || data.tags) {
                renderContent(data);
            }
            
            document.getElementById('generateBtn').disabled = false;
            
            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(() => {
                hideProgress();
            }, 3000);
        }
        
        function onGenerationError(message) {
            document.getElementById('progressFill').style.background = '#ff4d4f';
            document.getElementById('progressTitle').textContent = 'âŒ ç”Ÿæˆå¤±è´¥';
            document.getElementById('currentStage').textContent = message;
            document.getElementById('currentStage').style.color = '#ff4d4f';
            
            document.getElementById('generateBtn').disabled = false;
            showError(message);
            
            setTimeout(() => {
                hideProgress();
                document.getElementById('currentStage').style.color = '';
                document.getElementById('progressFill').style.background = '';
            }, 5000);
        }
        
        function onGenerationCancelled() {
            document.getElementById('progressFill').style.background = '#faad14';
            document.getElementById('progressTitle').textContent = 'âš ï¸ å·²å–æ¶ˆç”Ÿæˆ';
            document.getElementById('currentStage').textContent = 'ä»»åŠ¡å·²è¢«ç”¨æˆ·å–æ¶ˆ';
            document.getElementById('currentStage').style.color = '#faad14';
            
            document.getElementById('generateBtn').disabled = false;
            
            setTimeout(() => {
                hideProgress();
                document.getElementById('currentStage').style.color = '';
                document.getElementById('progressFill').style.background = '';
            }, 3000);
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = 'âŒ ' + message;
            errorMsg.classList.add('show');
        }
        
        // å¤åˆ¶æ–‡æ¡ˆåˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            if (!currentResult) {
                alert('è¯·å…ˆç”Ÿæˆå†…å®¹');
                return;
            }
            
            const title = currentResult.titles?.[0] || '';
            const copy = currentResult.copywriting || '';
            const tags = (currentResult.tags || []).map(t => '#' + t).join(' ');
            
            const fullText = `${title}\n\n${copy}\n\n${tags}`;
            
            navigator.clipboard.writeText(fullText).then(() => {
                alert('âœ… æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }
        
        // ä¸‹è½½å›¾ç‰‡
        async function downloadImages() {
            if (!currentResult || !currentResult.image_urls || currentResult.image_urls.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
                return;
            }
            
            const urls = currentResult.image_urls;
            alert(`å¼€å§‹ä¸‹è½½ ${urls.length} å¼ å›¾ç‰‡`);
            
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                try {
                    // ä½¿ç”¨ fetch ä¸‹è½½å¹¶åˆ›å»º blob
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `xhs_${i + 1}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // ç­‰å¾…ä¸‹è½½å®Œæˆåå†é‡Šæ”¾ blob URL
                    await new Promise(r => setTimeout(r, 200));
                    URL.revokeObjectURL(blobUrl);
                    
                    console.log(`âœ“ ç¬¬ ${i + 1}/${urls.length} å¼ å›¾ç‰‡ä¸‹è½½æˆåŠŸ`);
                    
                    // ç­‰å¾…ç”¨æˆ·ç¡®è®¤æˆ–å»¶è¿Ÿåå†ä¸‹è½½ä¸‹ä¸€å¼ 
                    if (i < urls.length - 1) {
                        // å»¶è¿Ÿ 1.5 ç§’ï¼Œç¡®ä¿å½“å‰ä¸‹è½½å®Œå…¨å®Œæˆ
                        await new Promise(r => setTimeout(r, 3000));
                    }
                } catch (e) {
                    console.error(`âœ— ä¸‹è½½ç¬¬ ${i + 1} å¼ å›¾ç‰‡å¤±è´¥:`, e);
                    // é™çº§ï¼šç›´æ¥æ‰“å¼€é“¾æ¥
                    window.open(url, '_blank');
                    // å¤±è´¥ä¹Ÿè¦å»¶è¿Ÿï¼Œé¿å…å¿«é€Ÿé‡è¯•
                    if (i < urls.length - 1) {
                        await new Promise(r => setTimeout(r, 1500));
                    }
                }
            }
            
            alert(`âœ“ æ‰€æœ‰ ${urls.length} å¼ å›¾ç‰‡ä¸‹è½½å®Œæˆ`);
            console.log(`âœ“ æ‰€æœ‰ ${urls.length} å¼ å›¾ç‰‡ä¸‹è½½å®Œæˆ`);
        }
        
        // æ‰“å¼€å‘å¸ƒå¼¹çª—
        function openPublishDialog() {
            if (!currentResult) {
                alert('è¯·å…ˆç”Ÿæˆå†…å®¹');
                return;
            }
            document.getElementById('publishModal').style.display = 'flex';
        }
        
        // å…³é—­å‘å¸ƒå¼¹çª—
        function closePublishDialog() {
            document.getElementById('publishModal').style.display = 'none';
        }
        
        // è§£æ Cookie å­—ç¬¦ä¸²ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function parseCookies(cookieText) {
            // å°è¯• JSON æ ¼å¼
            try {
                const parsed = JSON.parse(cookieText);
                if (Array.isArray(parsed)) return parsed;
            } catch (e) {}
            
            // è§£ææµè§ˆå™¨åŸå§‹ Cookie å­—ç¬¦ä¸²æ ¼å¼: "name1=value1; name2=value2"
            const cookies = [];
            const pairs = cookieText.split(';');
            for (const pair of pairs) {
                const trimmed = pair.trim();
                if (!trimmed) continue;
                const eqIndex = trimmed.indexOf('=');
                if (eqIndex > 0) {
                    cookies.push({
                        name: trimmed.substring(0, eqIndex).trim(),
                        value: trimmed.substring(eqIndex + 1).trim(),
                        domain: '.xiaohongshu.com',
                        path: '/'
                    });
                }
            }
            return cookies;
        }
        
        // å‘å¸ƒåˆ°å°çº¢ä¹¦
        async function publishToXHS() {
            console.log('ğŸš€ publishToXHS è¢«è°ƒç”¨');
            
            const cookieText = document.getElementById('cookieInput').value.trim();
            
            if (!cookieText) {
                alert('è¯·è¾“å…¥ Cookie');
                return;
            }
            
            const cookies = parseCookies(cookieText);
            if (!cookies || cookies.length === 0) {
                alert('Cookie è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                return;
            }
            
            if (!currentResult) {
                alert('è¯·å…ˆç”Ÿæˆå†…å®¹');
                return;
            }
            
            if (!currentResult.image_urls || currentResult.image_urls.length === 0) {
                alert('æ²¡æœ‰å¯å‘å¸ƒçš„å›¾ç‰‡');
                return;
            }
            
            closePublishDialog();
            
            // æ˜¾ç¤ºå‘å¸ƒä¸­çŠ¶æ€
            showProgress();
            document.getElementById('progressTitle').textContent = 'ğŸ“¤ æ­£åœ¨å‘å¸ƒåˆ°å°çº¢ä¹¦...';
            document.getElementById('currentStage').textContent = 'å‡†å¤‡å‘å¸ƒ...';
            
            try {
                const response = await fetch('/api/xhs/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cookies: cookies,
                        title: currentResult.titles?.[0] || currentResult.topic || '',
                        content: currentResult.copywriting || '',
                        tags: currentResult.tags || [],
                        images: currentResult.image_urls || []
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ğŸ‰ å‘å¸ƒæˆåŠŸï¼' + (result.url ? '\nç¬”è®°é“¾æ¥: ' + result.url : ''));
                } else {
                    alert('âŒ å‘å¸ƒå¤±è´¥: ' + (result.message || result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ å‘å¸ƒå¤±è´¥: ' + error.message);
            } finally {
                hideProgress();
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('publishModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePublishDialog();
            }
        });
        
        // åŠ è½½å°çº¢ä¹¦å†å²è®°å½•è¯¦æƒ…
        async function loadXhsHistory(historyId) {
            console.log('ğŸ” å¼€å§‹åŠ è½½å†å²è®°å½•:', historyId);
            try {
                const response = await fetch(`/api/history/${historyId}`);
                console.log('ğŸ“¡ API å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('ğŸ“¦ API è¿”å›æ•°æ®:', data);
                
                if (data.success && data.record) {
                    const record = data.record;
                    console.log('âœ… è®°å½•åŠ è½½æˆåŠŸ:', record.id);
                    
                    // å¡«å……ä¸»é¢˜
                    document.getElementById('topicInput').value = record.topic || '';
                    
                    // è§£æå›¾ç‰‡åˆ—è¡¨
                    let imageUrls = [];
                    try {
                        imageUrls = JSON.parse(record.xhs_image_urls || '[]');
                    } catch (e) {
                        console.warn('è§£æå›¾ç‰‡åˆ—è¡¨å¤±è´¥:', e);
                    }
                    
                    // è§£ææ ‡ç­¾ï¼ˆæ•°æ®åº“å­—æ®µæ˜¯ xhs_hashtagsï¼‰
                    let tags = [];
                    try {
                        tags = JSON.parse(record.xhs_hashtags || '[]');
                    } catch (e) {
                        console.warn('è§£ææ ‡ç­¾å¤±è´¥:', e);
                    }
                    
                    // æ„å»ºç»“æœå¯¹è±¡ï¼ˆæ•°æ®åº“å­—æ®µæ˜¯ xhs_copy_textï¼‰
                    currentResult = {
                        id: record.id,
                        topic: record.topic,
                        image_urls: imageUrls,
                        video_url: record.cover_video || '',
                        titles: [record.topic],  // ä½¿ç”¨ä¸»é¢˜ä½œä¸ºæ ‡é¢˜
                        copywriting: record.xhs_copy_text || '',
                        tags: tags
                    };
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayHistoryResult(currentResult);
                } else {
                    console.error('è·å–è®°å½•å¤±è´¥:', data.error);
                    alert('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½å°çº¢ä¹¦å†å²è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å†å²è®°å½•å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•ç»“æœ
        function displayHistoryResult(result) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').classList.add('show');
            
            // åˆ›å»ºå›¾ç‰‡æ§½ä½ï¼ˆæ³¨æ„ï¼šå…ƒç´  ID æ˜¯ imagesGridï¼‰
            const imageGrid = document.getElementById('imagesGrid');
            imageGrid.innerHTML = result.image_urls.map((url, index) => `
                <div class="image-card" id="image-slot-${index}">
                    <img src="${url}" alt="ç¬¬${index + 1}å¼ ">
                    <div class="caption">ç¬¬ ${index + 1} é¡µ${index === 0 ? ' (å°é¢)' : ''}</div>
                </div>
            `).join('');
            
            // æ˜¾ç¤ºæ–‡æ¡ˆ
            renderContent({
                titles: result.titles,
                copywriting: result.copywriting,
                tags: result.tags
            });
            
            // æ˜¾ç¤ºè§†é¢‘ï¼ˆå¦‚æœæœ‰ï¼‰
            if (result.video_url) {
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.innerHTML = `
                        <video src="${result.video_url}" controls autoplay loop muted style="max-width: 200px; border-radius: 12px;"></video>
                    `;
                    videoContainer.style.display = 'block';
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ£€æŸ¥ URL å‚æ•°
        (function initFromUrlParams() {
            console.log('ğŸš€ åˆå§‹åŒ– URL å‚æ•°');
            const params = new URLSearchParams(window.location.search);
            const topic = params.get('topic');
            const sourceId = params.get('source_id');
            const historyId = params.get('history_id');
            console.log('ğŸ“‹ URL å‚æ•°:', { topic, sourceId, historyId });
            
            if (topic) {
                document.getElementById('topicInput').value = topic;
            }
            if (sourceId) {
                window.xhsSourceId = sourceId;
            }
            
            // å¦‚æœæœ‰ history_idï¼ŒåŠ è½½å†å²è®°å½•è¯¦æƒ…
            if (historyId) {
                console.log('ğŸ“¥ å‡†å¤‡åŠ è½½å†å²è®°å½•:', historyId);
                loadXhsHistory(historyId);
            }
        })();
    </script>
</body>
</html>
