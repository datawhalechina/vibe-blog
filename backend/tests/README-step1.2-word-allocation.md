# Step 1.2 å­—æ•°åˆ†é…è§„åˆ™ â€” E2E æµ‹è¯•è¯´æ˜

## ä¸€ã€éœ€æ±‚ç›®æ ‡

åœ¨ `planner.j2` æ¨¡æ¿ä¸­æ–°å¢**å­—æ•°åˆ†é…è§„åˆ™**ï¼Œè®© Planner Agent æŒ‰ `narrative_role` æ¨èæ¯”ä¾‹ä¸ºæ¯ç« åˆ†é…ç›®æ ‡å­—æ•°ï¼ˆ`target_words`ï¼‰ï¼Œç¡®ä¿æ€»å’Œç­‰äºç›®æ ‡å­—æ•°ã€‚

## äºŒã€æµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶**: `backend/tests/test_70_1_2_word_allocation_e2e.py`

**å¯¹é½æ–¹æ¡ˆæ–‡æ¡£**: `vibe-blog-plan-æ–¹æ¡ˆ/70.1.2. Step1.2-å­—æ•°åˆ†é…è§„åˆ™.md`

## ä¸‰ã€è¿è¡Œæ–¹å¼

### 3.1 å‰ç½®æ¡ä»¶

ç¡®ä¿å‰åç«¯æœåŠ¡å·²å¯åŠ¨ï¼š

```bash
bash docker/start-local.sh
```

### 3.2 è¿è¡Œæµ‹è¯•

```bash
# 1. æœ‰å¤´æ¨¡å¼ï¼ˆå¯çœ‹åˆ°æµè§ˆå™¨æ“ä½œï¼‰
cd backend && python tests/test_70_1_2_word_allocation_e2e.py --headed

# 2. æ— å¤´æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œåå°è¿è¡Œï¼‰
cd backend && python tests/test_70_1_2_word_allocation_e2e.py

# 3. API æ¨¡å¼ï¼ˆä¸å¯åŠ¨æµè§ˆå™¨ï¼Œç›´æ¥è°ƒç”¨ APIï¼‰
cd backend && python tests/test_70_1_2_word_allocation_e2e.py --api-only

# 4. è¿è¡Œå•ä¸ªç”¨ä¾‹
cd backend && python tests/test_70_1_2_word_allocation_e2e.py --headed --cases 1

# 5. è¿è¡ŒæŒ‡å®šç”¨ä¾‹
cd backend && python tests/test_70_1_2_word_allocation_e2e.py --headed --cases 1,3
```

## å››ã€æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ | ä¸»é¢˜ | target_length | æœŸæœ›æ€»å­—æ•° | éªŒè¯ç‚¹ |
|------|------|--------------|-----------|--------|
| 1 | ä»€ä¹ˆæ˜¯ RAG | mini | 2000 å­— | å­—æ®µå®Œæ•´æ€§ + æ€»å’Œå‡†ç¡®æ€§ |
| 2 | æ‰‹æŠŠæ‰‹æ­å»º RAG ç³»ç»Ÿ | medium | 6000 å­— | å­—æ®µå®Œæ•´æ€§ + æ€»å’Œå‡†ç¡®æ€§ |
| 3 | 10 ä¸ª RAG æ€§èƒ½ä¼˜åŒ–æŠ€å·§ | long | 10000 å­— | å­—æ®µå®Œæ•´æ€§ + æ€»å’Œå‡†ç¡®æ€§ |

## äº”ã€éªŒè¯å†…å®¹

### Aè¡¨ â€” å­—æ®µæ£€æŸ¥ï¼ˆ3é¡¹ï¼‰

| æ£€æŸ¥é¡¹ | é€šè¿‡æ ‡å‡† |
|--------|---------|
| A1: æ¯ä¸ª section æœ‰ `target_words` å­—æ®µ | æ•´æ•°ï¼Œ> 0 |
| A2: æ‰€æœ‰ `target_words` ä¸ºæ­£æ•´æ•° | æ— è´Ÿæ•°æˆ– 0 |
| A3: å­—æ•°æ€»å’Œå‡†ç¡®æ€§ | ä¸æ€»ç›®æ ‡å­—æ•°è¯¯å·® â‰¤10% |

### Bè¡¨ â€” åˆç†æ€§æ£€æŸ¥ï¼ˆ3é¡¹ï¼‰

| æ£€æŸ¥é¡¹ | é€šè¿‡æ ‡å‡† |
|--------|---------|
| B1: æœ€å¤§ç« èŠ‚å­—æ•° â‰¤ æ€»å­—æ•° 40% | é¿å…å•ç« è¿‡é•¿ |
| B2: æœ€å°ç« èŠ‚å­—æ•° â‰¥ 200 å­— | é¿å…ç« èŠ‚è¿‡çŸ­ |
| B3: å­—æ•°åˆ†é…ä¸ narrative_role åŒ¹é… | è‡³å°‘ 60% ç« èŠ‚ç¬¦åˆæ¨èæ¯”ä¾‹ |

### narrative_role æ¨èæ¯”ä¾‹

| narrative_role | æ¨èæ¯”ä¾‹ | è¯´æ˜ |
|---------------|---------|------|
| hook | 10-15% | å¼•å­ç« èŠ‚ï¼Œå¿«é€Ÿå¸å¼•æ³¨æ„åŠ› |
| what | 15-20% | æ¦‚å¿µå®šä¹‰ï¼Œéœ€è¦å……åˆ†è§£é‡Š |
| why | 10-15% | åŠ¨æœºè¯´æ˜ï¼Œé€‚ä¸­ç¯‡å¹… |
| how | 25-35% | æ“ä½œæ­¥éª¤ï¼Œæ ¸å¿ƒå†…å®¹ï¼Œç¯‡å¹…æœ€å¤§ |
| deep_dive | 20-30% | æ·±å…¥åŸç†ï¼Œéœ€è¦è¯¦ç»†å±•å¼€ |
| compare | 15-20% | å¯¹æ¯”åˆ†æï¼Œéœ€è¦å……åˆ†è®ºè¯ |
| verify | 10-15% | éªŒè¯æµ‹è¯•ï¼Œé€‚ä¸­ç¯‡å¹… |
| summary | 5-10% | æ€»ç»“ç« èŠ‚ï¼Œç®€æ´æ”¶å°¾ |

## å…­ã€é€šè¿‡æ ‡å‡†

| ç»´åº¦ | é€šè¿‡æ¡ä»¶ |
|------|---------|
| **å­—æ®µå®Œæ•´æ€§** | 3 ä¸ªä¸»é¢˜å…¨éƒ¨è¾“å‡º `target_words` |
| **æ€»å’Œå‡†ç¡®** | 3 ä¸ªä¸»é¢˜çš„å­—æ•°æ€»å’Œè¯¯å·®å‡ â‰¤10% |
| **æ¯”ä¾‹åˆç†** | è‡³å°‘ 2/3 ä¸»é¢˜çš„å­—æ•°åˆ†é…ç¬¦åˆæ¨èæ¯”ä¾‹ |

## ä¸ƒã€æŠ€æœ¯å®ç°

### 7.1 æµ‹è¯•æ¶æ„

```
Playwright æµè§ˆå™¨
    â†’ æ³¨å…¥ SSE Hook JSï¼ˆæ‹¦æˆª EventSourceï¼‰
    â†’ ä½¿ç”¨ e2e_utils.run_playwright_generation()
    â†’ è¾“å…¥ä¸»é¢˜ + é€‰æ‹©é•¿åº¦
    â†’ ç‚¹å‡»ç”ŸæˆæŒ‰é’®
    â†’ ç­‰å¾… outline_complete äº‹ä»¶
    â†’ éªŒè¯ target_words å­—æ®µ
    â†’ å–æ¶ˆä»»åŠ¡
```

### 7.2 å¤ç”¨ e2e_utils

æœ¬æµ‹è¯•å¤ç”¨äº† `e2e_utils.py` ä¸­çš„å…±äº«å·¥å…·ï¼š

- `SSE_HOOK_JS`: EventSource ä»£ç†è„šæœ¬
- `run_playwright_generation()`: é€šç”¨å‰ç«¯äº¤äº’æµç¨‹
- `cancel_task()`: å–æ¶ˆä»»åŠ¡å·¥å…·å‡½æ•°

### 7.3 éªŒè¯é€»è¾‘

```python
# Aè¡¨ï¼šå­—æ®µæ£€æŸ¥
field_results = validate_field_completeness(outline, expected_total_words)

# Bè¡¨ï¼šåˆç†æ€§æ£€æŸ¥
ratio_results = validate_allocation_ratios(outline, expected_total_words)

# åˆ¤å®šé€šè¿‡/å¤±è´¥
passed = (
    field_results["has_target_words"] and
    field_results["all_positive"] and
    field_results["sum_accuracy"] and
    ratio_results["max_section_ok"] and
    ratio_results["min_section_ok"]
)
```

## å…«ã€è¾“å‡ºç¤ºä¾‹

```
============================================================
ğŸ“Š Step 1.2 å­—æ•°åˆ†é…è§„åˆ™ E2E éªŒè¯æ±‡æ€»
============================================================
  âœ… ç”¨ä¾‹ 1: ä»€ä¹ˆæ˜¯ RAG
      å®é™…å­—æ•°: 2000, æœŸæœ›: 2000
  âœ… ç”¨ä¾‹ 2: æ‰‹æŠŠæ‰‹æ­å»º RAG ç³»ç»Ÿ
      å®é™…å­—æ•°: 6000, æœŸæœ›: 6000
  âœ… ç”¨ä¾‹ 3: 10 ä¸ª RAG æ€§èƒ½ä¼˜åŒ–æŠ€å·§
      å®é™…å­—æ•°: 10000, æœŸæœ›: 10000

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  é€šè¿‡æ ‡å‡†ï¼ˆå¯¹é½ 70.1.2 éªŒè¯æ–¹æ¡ˆï¼‰ï¼š
    âœ… å­—æ®µå®Œæ•´æ€§: 3/3 ä¸»é¢˜é€šè¿‡ï¼ˆè¦æ±‚å…¨éƒ¨ï¼‰
    âœ… æ€»å’Œå‡†ç¡®: 3/3 ä¸»é¢˜è¯¯å·® â‰¤10%ï¼ˆè¦æ±‚å…¨éƒ¨ï¼‰
    âœ… æ¯”ä¾‹åˆç†: 3/3 ä¸»é¢˜ç¬¦åˆæ¯”ä¾‹ï¼ˆè¦æ±‚ â‰¥2ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ‰ æ€»ä½“åˆ¤å®šï¼šé€šè¿‡
============================================================
```

## ä¹ã€å¸¸è§é—®é¢˜

### 9.1 Playwright æœªå®‰è£…

**ç°è±¡**: æç¤º `Playwright æœªå®‰è£…ï¼Œå›é€€åˆ° API E2E æ¨¡å¼`

**è§£å†³**:
```bash
pip install playwright
playwright install chromium
```

### 9.2 å‰ç«¯æœªå¯åŠ¨

**ç°è±¡**: æµ‹è¯•å¡åœ¨ "æ‰“å¼€é¦–é¡µ" æ­¥éª¤

**è§£å†³**: ç¡®ä¿å‰ç«¯æœåŠ¡è¿è¡Œåœ¨ `http://localhost:5173`
```bash
cd frontend && npm run dev
```

### 9.3 åç«¯æœªå¯åŠ¨

**ç°è±¡**: API è°ƒç”¨å¤±è´¥

**è§£å†³**: ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ `http://localhost:5001`
```bash
cd backend && python app.py
```

### 9.4 å­—æ•°æ€»å’Œè¯¯å·®è¿‡å¤§

**ç°è±¡**: A3 æ£€æŸ¥å¤±è´¥ï¼Œè¯¯å·® > 10%

**å¯èƒ½åŸå› **:
- planner.j2 ä¸­çš„å­—æ•°åˆ†é…è§„åˆ™æè¿°ä¸å¤Ÿæ¸…æ™°
- LLM æ•°å­¦èƒ½åŠ›ä¸è¶³

**æ’æŸ¥æ–¹å¼**:
- æ£€æŸ¥ planner.j2 ä¸­æ˜¯å¦æœ‰ "æ€»å’Œå¿…é¡»ç­‰äº X" çš„å¼ºçº¦æŸ
- æŸ¥çœ‹ outline JSON ä¸­å„ç« èŠ‚çš„ target_words åˆ†é…

### 9.5 æ¯”ä¾‹ä¸åˆç†

**ç°è±¡**: B3 æ£€æŸ¥å¤±è´¥ï¼Œå­—æ•°åˆ†é…ä¸ narrative_role ä¸åŒ¹é…

**å¯èƒ½åŸå› **:
- planner.j2 ä¸­çš„æ¯”ä¾‹è¡¨æè¿°ä¸å¤Ÿæ¸…æ™°
- ç¼ºå°‘å…·ä½“æ•°å­—ç¤ºä¾‹

**æ’æŸ¥æ–¹å¼**:
- æ£€æŸ¥ planner.j2 ä¸­æ˜¯å¦æœ‰æ¯”ä¾‹è¡¨å’Œç¤ºä¾‹
- æŸ¥çœ‹å…·ä½“å“ªäº›ç« èŠ‚çš„æ¯”ä¾‹è¶…å‡ºèŒƒå›´

## åã€ä¸ Step 1.1 çš„å…³ç³»

Step 1.2 ä¾èµ– Step 1.1 çš„ `narrative_role` å­—æ®µï¼š

```
Step 1.1: å™äº‹æµè®¾è®¡
    â†’ è¾“å‡º narrative_mode, narrative_flow, narrative_role

Step 1.2: å­—æ•°åˆ†é…è§„åˆ™
    â†’ æ ¹æ® narrative_role åˆ†é… target_words
    â†’ ç¡®ä¿æ€»å’Œç­‰äºç›®æ ‡å­—æ•°
```

å› æ­¤ï¼Œè¿è¡Œ Step 1.2 æµ‹è¯•å‰ï¼Œéœ€è¦ç¡®ä¿ Step 1.1 å·²ç»å®ç°å¹¶é€šè¿‡æµ‹è¯•ã€‚

## åä¸€ã€æäº¤ä¿¡æ¯

```bash
git add backend/tests/test_70_1_2_word_allocation_e2e.py
git commit -m "test(planner): add E2E test with Playwright for word allocation

- Use Playwright for real browser automation (with --headed/--api-only modes)
- Test field completeness (Aè¡¨): target_words existence and sum accuracy
- Test allocation ratios (Bè¡¨): max/min constraints and role-based ratios
- Support 3 test cases: mini (2000å­—), medium (6000å­—), long (10000å­—)
- Reuse e2e_utils for SSE hook and frontend interaction
- Ref: 70.1.2 Step1.2-å­—æ•°åˆ†é…è§„åˆ™.md

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```
