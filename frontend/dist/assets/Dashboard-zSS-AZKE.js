import{d as J,u as H,q as G,U as K,c as o,b as Q,a as s,t as a,F as p,r as k,g as r,f as C,v as x,n as q,i as A,l as O,h as u,o as l,m as R,aL as W,_ as X}from"./index-DnPWu-9Z.js";const Y={class:"dashboard-content"},Z={class:"stats-grid"},ss={class:"stat-card"},ts={class:"stat-value"},es={class:"stat-card"},as={class:"stat-value"},ns={class:"stat-card"},os={class:"stat-value"},ls={class:"stat-card"},is={class:"stat-value"},cs={class:"stat-card"},ds={class:"stat-value"},rs={key:0,class:"task-section"},us={class:"task-list"},_s={class:"task-header"},hs={class:"task-name"},vs={class:"task-stage"},ps={class:"progress-bar"},ks={class:"task-footer"},ms={class:"task-detail"},fs={class:"task-progress-text"},gs=["onClick"],ys={key:1,class:"task-section"},bs={class:"task-list"},ws={class:"task-header"},Ts={class:"task-name"},$s={class:"task-badge queued-badge"},Ss={class:"task-footer"},Cs={class:"task-detail"},xs=["onClick"],qs={key:2,class:"task-section"},Ds={class:"task-list"},Es={class:"task-header"},js={class:"task-name"},Ns={class:"task-footer"},As={class:"task-detail"},Os={class:"task-time"},Vs={key:3,class:"task-section"},Ls={class:"task-list"},Ms={class:"task-header"},Ps={class:"task-name"},Us={class:"task-footer"},Bs={class:"task-detail"},Fs={class:"task-time"},Is={key:4,class:"task-section"},zs={class:"task-list"},Js={class:"task-header"},Hs={class:"task-name"},Gs={class:"task-footer"},Ks={class:"task-detail"},Qs={class:"task-time"},Rs={class:"task-section"},Ws={class:"section-header"},Xs={key:0,class:"schedule-form"},Ys={class:"form-row"},Zs={class:"form-row"},st={key:0,class:"parsed-result"},tt={key:0},et={key:1,class:"error-text"},at=["disabled"],nt={key:1,class:"task-list"},ot={class:"task-header"},lt={class:"task-name"},it={class:"task-footer"},ct={class:"task-detail"},dt={class:"task-actions"},rt=["onClick"],ut=["onClick"],_t={key:2,class:"empty-hint"},_="",ht=J({__name:"Dashboard",setup(vt){const V=H(),L=A(()=>V.isDark),h=O({running_count:0,queued_count:0,completed_today:0,failed_count:0,cancelled_count:0}),g=u([]),y=u([]),b=u([]),w=u([]),T=u([]),$=u([]),v=u(!1),i=O({name:"",topic:"",scheduleText:""}),c=u(null),D=A(()=>{var n;return i.name&&i.topic&&((n=c.value)==null?void 0:n.type)!=="error"&&c.value});let S=null;async function E(){try{const t=await(await fetch(`${_}/api/queue/tasks`)).json();Object.assign(h,t.stats||{}),g.value=t.running||[],y.value=t.queued||[],b.value=t.failed||[],w.value=t.cancelled||[]}catch{}}async function M(){try{const t=await(await fetch(`${_}/api/queue/history?limit=10`)).json();T.value=t.history||t||[]}catch{}}async function m(){try{const t=await(await fetch(`${_}/api/scheduler/tasks`)).json();$.value=Array.isArray(t)?t:[]}catch{}}async function j(n){await fetch(`${_}/api/queue/tasks/${n}`,{method:"DELETE"}),await E()}async function P(){try{const n=await fetch(`${_}/api/scheduler/parse-schedule`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:i.scheduleText})});c.value=await n.json()}catch{c.value={type:"error",error:"解析失败"}}}async function U(){if(!D.value||!c.value)return;const n=c.value.type==="cron"?{type:"cron",cron:c.value.cron}:{type:"date",run_date:c.value.run_date};await fetch(`${_}/api/scheduler/tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i.name,trigger:n,generation:{topic:i.topic}})}),i.name="",i.topic="",i.scheduleText="",c.value=null,v.value=!1,await m()}async function B(n){const t=n.enabled?"pause":"resume";await fetch(`${_}/api/scheduler/tasks/${n.id}/${t}`,{method:"POST"}),await m()}async function F(n){await fetch(`${_}/api/scheduler/tasks/${n}`,{method:"DELETE"}),await m()}function I(n){if(!n)return"-";if(n<1e3)return`${n}ms`;const t=Math.round(n/1e3);return t<60?`${t}s`:`${Math.floor(t/60)}m${t%60}s`}function f(n){return n?new Date(n).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}async function N(){await Promise.all([E(),M(),m()])}return G(()=>{N(),S=setInterval(N,3e3)}),K(()=>{S&&clearInterval(S)}),(n,t)=>(l(),o("div",{class:q(["dashboard-container",{"dark-mode":L.value}])},[Q(W,{"app-config":{title:"任务中心"}}),s("div",Y,[t[17]||(t[17]=s("h1",{class:"dashboard-title"},"任务中心",-1)),s("div",Z,[s("div",ss,[s("div",ts,a(h.running_count),1),t[4]||(t[4]=s("div",{class:"stat-label"},"处理中",-1))]),s("div",es,[s("div",as,a(h.queued_count),1),t[5]||(t[5]=s("div",{class:"stat-label"},"等待中",-1))]),s("div",ns,[s("div",os,a(h.completed_today),1),t[6]||(t[6]=s("div",{class:"stat-label"},"今日完成",-1))]),s("div",ls,[s("div",is,a(h.failed_count),1),t[7]||(t[7]=s("div",{class:"stat-label"},"失败",-1))]),s("div",cs,[s("div",ds,a(h.cancelled_count),1),t[8]||(t[8]=s("div",{class:"stat-label"},"已取消",-1))])]),g.value.length?(l(),o("section",rs,[t[9]||(t[9]=s("h2",null,"处理中",-1)),s("div",us,[(l(!0),o(p,null,k(g.value,e=>{var d;return l(),o("div",{class:"task-card running",key:e.id},[s("div",_s,[s("span",hs,a(e.name),1),s("span",vs,a(e.current_stage||"准备中..."),1)]),s("div",ps,[s("div",{class:"progress-fill",style:R({width:(e.progress||0)+"%"})},null,4)]),s("div",ks,[s("span",ms,a(e.stage_detail||((d=e.generation)==null?void 0:d.topic)),1),s("span",fs,a(e.progress||0)+"%",1),s("button",{class:"btn-cancel",onClick:z=>j(e.id)},"取消",8,gs)])])}),128))])])):r("",!0),y.value.length?(l(),o("section",ys,[t[10]||(t[10]=s("h2",null,"等待中",-1)),s("div",bs,[(l(!0),o(p,null,k(y.value,e=>{var d;return l(),o("div",{class:"task-card queued",key:e.id},[s("div",ws,[s("span",Ts,a(e.name),1),s("span",$s,"排队 #"+a(e.queue_position),1)]),s("div",Ss,[s("span",Cs,a((d=e.generation)==null?void 0:d.topic),1),s("button",{class:"btn-cancel",onClick:z=>j(e.id)},"取消",8,xs)])])}),128))])])):r("",!0),T.value.length?(l(),o("section",qs,[t[11]||(t[11]=s("h2",null,"最近完成",-1)),s("div",Ds,[(l(!0),o(p,null,k(T.value,e=>(l(),o("div",{class:"task-card completed",key:e.task_id},[s("div",Es,[s("span",js,a(e.task_name),1),s("span",{class:q(["task-badge",e.status==="completed"?"success-badge":"fail-badge"])},a(e.status==="completed"?"成功":"失败"),3)]),s("div",Ns,[s("span",As,"耗时 "+a(I(e.duration_ms)),1),s("span",Os,a(f(e.completed_at)),1)])]))),128))])])):r("",!0),b.value.length?(l(),o("section",Vs,[t[13]||(t[13]=s("h2",null,"失败",-1)),s("div",Ls,[(l(!0),o(p,null,k(b.value,e=>{var d;return l(),o("div",{class:"task-card failed",key:e.id},[s("div",Ms,[s("span",Ps,a(e.name),1),t[12]||(t[12]=s("span",{class:"task-badge fail-badge"},"失败",-1))]),s("div",Us,[s("span",Bs,a(e.stage_detail||((d=e.generation)==null?void 0:d.topic)),1),s("span",Fs,a(f(e.completed_at||e.created_at)),1)])])}),128))])])):r("",!0),w.value.length?(l(),o("section",Is,[t[15]||(t[15]=s("h2",null,"已取消",-1)),s("div",zs,[(l(!0),o(p,null,k(w.value,e=>{var d;return l(),o("div",{class:"task-card cancelled",key:e.id},[s("div",Js,[s("span",Hs,a(e.name),1),t[14]||(t[14]=s("span",{class:"task-badge cancelled-badge"},"已取消",-1))]),s("div",Gs,[s("span",Ks,a((d=e.generation)==null?void 0:d.topic),1),s("span",Qs,a(f(e.completed_at||e.created_at)),1)])])}),128))])])):r("",!0),s("section",Rs,[s("div",Ws,[t[16]||(t[16]=s("h2",null,"定时任务",-1)),s("button",{class:"btn-add",onClick:t[0]||(t[0]=e=>v.value=!v.value)},a(v.value?"收起":"+ 新建"),1)]),v.value?(l(),o("div",Xs,[s("div",Ys,[C(s("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>i.name=e),placeholder:"任务名称",class:"form-input"},null,512),[[x,i.name]]),C(s("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>i.topic=e),placeholder:"博客主题",class:"form-input"},null,512),[[x,i.topic]])]),s("div",Zs,[C(s("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>i.scheduleText=e),placeholder:"调度时间，如：每天上午9点",class:"form-input flex-2"},null,512),[[x,i.scheduleText]]),s("button",{class:"btn-parse",onClick:P},"解析")]),c.value?(l(),o("div",st,[c.value.type!=="error"?(l(),o("span",tt,a(c.value.description),1)):(l(),o("span",et,a(c.value.error),1))])):r("",!0),s("button",{class:"btn-create",onClick:U,disabled:!D.value},"创建定时任务",8,at)])):r("",!0),$.value.length?(l(),o("div",nt,[(l(!0),o(p,null,k($.value,e=>(l(),o("div",{class:"task-card scheduled",key:e.id},[s("div",ot,[s("span",lt,a(e.name),1),s("span",{class:q(["task-badge",e.enabled?"active-badge":"paused-badge"])},a(e.enabled?"运行中":"已暂停"),3)]),s("div",it,[s("span",ct,a(e.next_run?"下次: "+f(e.next_run):"已暂停"),1),s("div",dt,[s("button",{class:"btn-sm",onClick:d=>B(e)},a(e.enabled?"暂停":"恢复"),9,rt),s("button",{class:"btn-sm btn-danger",onClick:d=>F(e.id)},"删除",8,ut)])])]))),128))])):v.value?r("",!0):(l(),o("div",_t,"暂无定时任务"))])])],2))}}),kt=X(ht,[["__scopeId","data-v-6ea157c8"]]);export{kt as default};
